@page "/Signed"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using System.IdentityModel.Tokens.Jwt
@using RocketShop.Database.Model.Identity
@using RocketShop.Framework.Extension
@using RocketShop.HR.Services
@inject NavigationManager navigationManager;
@inject SignInManager<User> signInManager;
@inject IHttpContextAccessor accessor;
@inject IUserServices _userServices;
@code {
    protected override async Task OnInitializedAsync()
    {
        var uri = navigationManager.ToAbsoluteUri(navigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("id_token", out var idToken))
        {
            var handler = new JwtSecurityTokenHandler();
            var jwtSecurityToken = handler.ReadJwtToken(idToken);
            var subject = jwtSecurityToken.Subject;
            var user = await _userServices.FindById(subject);
            await signInManager.SignInWithClaimsAsync(user.GetRight().Extract()!, true, jwtSecurityToken.Claims);
            navigationManager.NavigateTo("/", true);
        }
    }
}
